<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor and Alarm API</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{--primary:#2c3e50;--accent:#3498db;--bg:#f4f6f9;--card:#fff;--text:#333;--safe:#27ae60;--warn:#f39c12;--danger:#c0392b}
    *{box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--bg);margin:0;display:flex;min-height:100vh;color:var(--text)}
    .sidebar{width:260px;background:var(--primary);color:#fff;padding:20px;display:flex;flex-direction:column}
    .sidebar h2{font-size:1.1rem;margin:0 0 20px;display:flex;align-items:center;gap:10px}
    .main{flex:1;padding:20px;overflow:auto}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    .dashboard-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-bottom:18px}
    .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .card-header{font-size:0.8rem;color:#768487;margin-bottom:6px;font-weight:700;text-transform:uppercase}
    .card-value{font-size:2.2rem;font-weight:700;color:var(--primary)}
    .muted{color:#666;font-size:0.9rem}
    .chart-row{display:grid;grid-template-columns:1fr 2fr;gap:18px}
    .gauge-wrapper{position:relative;height:250px;display:flex;align-items:center;justify-content:center}
    .gauge-label-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .gl-val{font-size:2.4rem;font-weight:700}
    .gl-unit{font-size:0.95rem;color:#7f8c8d}
    .status-badge{display:inline-block;padding:6px 12px;border-radius:20px;color:#fff;font-weight:700}
    .row{display:flex;gap:12px;align-items:center}
    .col{display:flex;flex-direction:column;gap:6px}
    .small{font-size:0.9rem;color:#666}
    button.btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #ddd;padding:6px 10px;border-radius:8px;cursor:pointer}
    @media (max-width:900px){
      body{flex-direction:column}
      .sidebar{width:100%;flex-direction:row;align-items:center;padding:12px;gap:12px}
      .dashboard-grid,.chart-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <aside class="sidebar">
    <h2><i class="fas fa-bell"></i> Monitor and Alarm API</h2>
    <div class="muted" style="font-size:0.95rem">Status: <strong id="connBadge">Connecting...</strong></div>
    <div style="margin-top:auto" class="muted" id="timestamp">Waiting for data...</div>
    <div style="margin-top:12px;font-size:0.85rem;color:#ddd">ESP32 → Firebase RTDB</div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <h1 style="margin:0">Monitor and Alarm API</h1>
        <div class="muted">Realtime monitoring — MQ-2 (avg), DHT22 (suhu), Ultrasonic (level)</div>
      </div>
      <div class="row">
        <div class="col" style="align-items:flex-end">
          <div class="small">MQ Alarm</div>
          <div id="alarmBadge" class="status-badge" style="background:#999">—</div>
        </div>
        <div style="width:12px"></div>
        <button id="resetAlarmBtn" class="btn">Reset Alarm</button>
      </div>
    </div>

    <div class="dashboard-grid">

      <!-- MQ RAW / AVG -->
      <div class="card">
        <div class="card-header">MQ-2 Sensor</div>
        <div class="row" style="align-items:center;justify-content:space-between">
          <div>
            <div class="muted">Raw</div>
            <div class="card-value" id="mqRaw">--</div>
          </div>
          <div>
            <div class="muted">Average</div>
            <div class="card-value" id="mqAvg">--</div>
          </div>
        </div>
        <div style="margin-top:10px" class="muted">
          Baseline: <strong id="mqBaseline">--</strong> &nbsp; • &nbsp; Threshold: <strong id="mqThres">--</strong>
        </div>
      </div>

      <!-- DHT -->
      <div class="card">
        <div class="card-header">DHT22</div>
        <div class="row">
          <div>
            <div class="muted">Temperature</div>
            <div class="card-value" id="dhtTemp">-- °C</div>
          </div>
          <div>
            <div class="muted">Humidity</div>
            <div class="card-value" id="dhtHum">-- %</div>
          </div>
        </div>
      </div>

      <!-- Status / Description -->
      <div class="card" id="statusCard" style="border-left:8px solid var(--safe)">
        <div class="card-header">Kondisi</div>
        <h3 id="txtStatus" style="margin:8px 0;font-size:1.1rem">--</h3>
        <div id="txtDesc" class="muted">Menunggu data...</div>
      </div>

    </div>

    <div class="chart-row">
      <!-- GAUGE (MQ-2 average) -->
      <div class="card">
        <div class="card-header">MQ-2 — Rata-rata (Avg)</div>
        <div class="gauge-wrapper">
          <canvas id="gaugeChart"></canvas>
          <div class="gauge-label-center">
            <span class="gl-val" id="gaugeVal">--</span>
            <div class="gl-unit">avg</div>
          </div>
        </div>
      </div>

      <!-- TEMPERATURE HISTORY GRAPH -->
      <div class="card">
        <div class="card-header">Riwayat Suhu (Realtime)</div>
        <div style="height:300px"><canvas id="historyChart"></canvas></div>
      </div>
    </div>

    <!-- (raw debug removed as requested) -->

  </main>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

  <script>
    // ---------- CONFIG: gunakan firebaseConfig projekmu ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDdDVBztKZIhDo8NT7p0DGzq_9EK2_W4bc",
      authDomain: "abel-2884d.firebaseapp.com",
      databaseURL: "https://abel-2884d-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "abel-2884d",
      storageBucket: "abel-2884d.appspot.com",
      messagingSenderId: "397236863376",
      appId: "1:397236863376:web:3b4f33b78d15d6f248f315",
      measurementId: "G-MTXSK5984V"
    };

    // init firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // elements
    const connBadge = document.getElementById('connBadge');
    const mqRawEl = document.getElementById('mqRaw');
    const mqAvgEl = document.getElementById('mqAvg');
    const mqBaselineEl = document.getElementById('mqBaseline');
    const mqThresEl = document.getElementById('mqThres');
    const alarmBadge = document.getElementById('alarmBadge');
    const txtStatus = document.getElementById('txtStatus');
    const txtDesc = document.getElementById('txtDesc');
    const dhtTemp = document.getElementById('dhtTemp');
    const dhtHum = document.getElementById('dhtHum');
    const gaugeVal = document.getElementById('gaugeVal');
    const timestampEl = document.getElementById('timestamp');
    const resetAlarmBtn = document.getElementById('resetAlarmBtn');

    // ---------- CHART SETUP ----------
    // We'll use MQ avg gauge with max = 4095 (ADC 12-bit)
    const maxMQ = 4095;
    const ctxG = document.getElementById('gaugeChart').getContext('2d');
    const gaugeChart = new Chart(ctxG, {
      type: 'doughnut',
      data: { labels:['val','rest'],
              datasets:[{
                data:[0, maxMQ],
                backgroundColor:['#c0392b','#ecf0f1'],
                borderWidth:0,
                circumference: 180,
                rotation: 270,
                cutout: '75%'
              }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false},tooltip:{enabled:false}}
      }
    });

    const ctxH = document.getElementById('historyChart').getContext('2d');
    const gradient = ctxH.createLinearGradient(0,0,0,300);
    gradient.addColorStop(0,'rgba(231,76,60,0.25)');
    gradient.addColorStop(1,'rgba(231,76,60,0)');
    const historyChart = new Chart(ctxH,{
      type:'line',
      data:{labels:[],datasets:[{label:'Suhu (°C)',data:[],borderColor:'#e74c3c',backgroundColor:gradient,fill:true,tension:0.35,pointRadius:0}]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          y:{beginAtZero:false, suggestedMin:15, suggestedMax:45}
        },
        plugins:{legend:{display:false}}
      }
    });

    function pushTempHistory(label, value){
      historyChart.data.labels.push(label);
      historyChart.data.datasets[0].data.push(value);
      if (historyChart.data.labels.length > 60){
        historyChart.data.labels.shift();
        historyChart.data.datasets[0].data.shift();
      }
      historyChart.update();
    }

    // ---------- AUTH auto ----------
    auth.signInAnonymously()
      .then(()=>{ connBadge.innerText='Online'; })
      .catch(err=>{ connBadge.innerText='Auth Error'; console.error(err); });

    // ---------- LISTENER ----------
    function handleSensorsSnapshot(data){
      if (!data) return;

      // MQ2 data (prefer /sensors/mq2)
      if (data.mq2) {
        const m = data.mq2;
        mqRawEl.innerText = (m.raw !== undefined) ? m.raw : '--';
        mqAvgEl.innerText = (m.avg !== undefined) ? m.avg : '--';
        mqBaselineEl.innerText = (m.baseline !== undefined) ? m.baseline : '--';
        mqThresEl.innerText = ( (m.baseline!==undefined) ? (parseInt(m.baseline) + 250) : '--' );

        // update gauge (use avg if available, fallback to raw)
        let gVal = (m.avg !== undefined) ? parseFloat(m.avg) : ((m.raw!==undefined)?parseFloat(m.raw):0);
        if (isNaN(gVal)) gVal = 0;
        gVal = Math.max(0, Math.min(maxMQ, gVal));
        gaugeVal.innerText = Math.round(gVal);
        gaugeChart.data.datasets[0].data = [gVal, Math.max(maxMQ - gVal, 0)];
        gaugeChart.update();

        // alarm
        const alarm = !!m.alarm;
        alarmBadge.innerText = alarm ? 'ALARM' : 'OK';
        alarmBadge.style.backgroundColor = alarm ? 'var(--danger)' : 'var(--safe)';
      } else {
        // no mq2 node — clear values
        mqRawEl.innerText = '--';
        mqAvgEl.innerText = '--';
        mqBaselineEl.innerText = '--';
        mqThresEl.innerText = '--';
        gaugeVal.innerText = '--';
        gaugeChart.data.datasets[0].data = [0, maxMQ];
        gaugeChart.update();
        alarmBadge.innerText = '—';
        alarmBadge.style.backgroundColor = '#999';
      }

      // DHT: prefer mqtt node dht or top-level dht
      let t = null, h = null;
      if (data.mq2 && data.mq2.dht){
        t = data.mq2.dht.temperature;
        h = data.mq2.dht.humidity;
      } else if (data.dht){
        t = data.dht.temperature; h = data.dht.humidity;
      } else if (data.mq2 && data.mq2.temp !== undefined){
        t = data.mq2.temp; h = data.mq2.hum;
      }

      if (t !== undefined && t !== null && !isNaN(t)){
        dhtTemp.innerText = parseFloat(t).toFixed(2) + ' °C';
        pushTempHistory(new Date().toLocaleTimeString(), parseFloat(t));
      } else {
        dhtTemp.innerText = '-- °C';
      }

      if (h !== undefined && h !== null && !isNaN(h)){
        dhtHum.innerText = parseFloat(h).toFixed(2) + ' %';
      } else {
        dhtHum.innerText = '-- %';
      }

      // Ultrasonic (optional) - if top-level ultrasonic exists, we don't display separately now
      // Status text / turbidity if present (kept for compatibility)
      if (data.turbidity && data.turbidity.voltage !== undefined){
        const v = parseFloat(data.turbidity.voltage) || 0;
        if (!isNaN(v)){
          const st = (v <= 0.5) ? 'Air Jernih' : (v <= 2.5 ? 'Air Keruh' : 'Air Sangat Keruh');
          txtStatus.innerText = data.turbidity.level || st;
          txtDesc.innerText = data.turbidity.description || '-';
        }
      }

      timestampEl.innerText = "Last Update: " + new Date().toLocaleString();
    }

    // attach listener on /sensors root
    db.ref('/sensors').on('value', snap => {
      const v = snap.val();
      if (v) handleSensorsSnapshot(v);
    });

    // also listen to /sensors/mq2 for direct node updates
    db.ref('/sensors/mq2').on('value', snap => {
      const v = snap.val();
      if (v) {
        const wrapper = { mq2: v, turbidity: (v.turbidity?v.turbidity:null) };
        handleSensorsSnapshot(wrapper);
      }
    });

    // ---------- Controls ----------
    resetAlarmBtn.addEventListener('click', ()=> {
      db.ref('/sensors/mq2/alarm').set(false)
        .then(()=>{ console.log('Alarm reset request sent'); })
        .catch(err=>{ console.error('Reset failed', err); alert('Reset failed: ' + err.message); });
    });

    // in case auth fails: show message in console
    auth.onAuthStateChanged(u => {
      if (!u) console.warn('Auth state: no user (DB rules might still allow public read).');
    });

  </script>
</body>
</html>
